name: GUI Responsiveness Check

on:
  push:
    paths:
      - 'qml/**'
      - 'scripts/dev/gui_probe.py'
      - 'scripts/dev/qml_lint.py'
      - '.github/workflows/gui-*.yml'
  pull_request:
    paths:
      - 'qml/**'
      - 'scripts/dev/gui_probe.py'
      - 'scripts/dev/qml_lint.py'

jobs:
  gui-lint:
    runs-on: ubuntu-latest
    name: QML Responsiveness Lint
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PySide6 psutil

      - name: Run QML linter
        run: python scripts/dev/qml_lint.py
        
      - name: QML linter result
        if: always()
        run: echo "✓ QML linter completed (check output above for warnings)"

  gui-probe:
    runs-on: ubuntu-latest
    name: GUI Probe Screenshots
    needs: gui-lint
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install PySide6 psutil
          sudo apt-get update
          sudo apt-get install -y libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-shape0 libxcb-xfixes0

      - name: Run GUI probe (headless)
        run: python scripts/dev/gui_probe.py
        env:
          QT_QPA_PLATFORM: offscreen
          QT_QPA_PLATFORM_PLUGIN_PATH: /usr/lib/qt6/plugins

      - name: Upload GUI screenshots
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gui-probe-screenshots
          path: artifacts/gui/*.png
          retention-days: 30
          if-no-files-found: warn

      - name: GUI probe result
        if: always()
        run: |
          if [ -d "artifacts/gui" ]; then
            echo "✓ Screenshots captured: $(ls -1 artifacts/gui/*.png 2>/dev/null | wc -l) viewport sizes"
          else
            echo "⚠ No screenshots captured (headless mode)"
          fi

  gui-summary:
    runs-on: ubuntu-latest
    name: GUI Check Summary
    needs: [gui-lint, gui-probe]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "=== GUI RESPONSIVENESS CHECK SUMMARY ==="
          echo "✓ QML Linter: Passed (see logs for warnings)"
          echo "✓ GUI Probe: Completed (check artifacts for screenshots)"
          echo ""
          echo "Next steps:"
          echo "1. Review linter warnings (qml_lint.py output)"
          echo "2. Download and review GUI screenshots from artifacts"
          echo "3. Prioritize fixes: text wrapping (high), font sizes (medium), icons (low)"
