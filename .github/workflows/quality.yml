name: Code Quality & Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  quality-check:
    name: Code Quality Checks
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy types-psutil types-pywin32
          
      - name: Run Ruff Linter
        run: |
          python -m ruff check app/ --output-format=github
        continue-on-error: true
        
      - name: Run Ruff Formatter Check
        run: |
          python -m ruff format app/ --check
        continue-on-error: true
        
      - name: Run MyPy Type Checking
        run: |
          python -m mypy app/ --config-file=pyproject.toml
        continue-on-error: true
        
      - name: Generate Quality Report
        if: always()
        run: |
          echo "## Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ruff Statistics" >> $GITHUB_STEP_SUMMARY
          python -m ruff check app/ --statistics >> $GITHUB_STEP_SUMMARY || true
          
  build-check:
    name: Build & Application Check
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify imports
        run: |
          python -c "from app.application import run; print('✓ Application imports OK')"
          
      - name: Check QML files exist
        run: |
          if (!(Test-Path "qml/main.qml")) { exit 1 }
          echo "✓ QML files present"
          
      - name: Verify pyproject.toml
        run: |
          python -c "import tomllib; f=open('pyproject.toml','rb'); tomllib.load(f); print('✓ pyproject.toml valid')"
        shell: bash
        
  security-scan:
    name: Security Scan
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Bandit
        run: pip install bandit[toml]
        
      - name: Run Bandit Security Scan
        run: |
          python -m bandit -r app/ -f json -o bandit-report.json || true
          python -m bandit -r app/ -ll
        continue-on-error: true
        
      - name: Upload Bandit Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          
  dependency-check:
    name: Dependency Security Check
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install pip-audit
        run: pip install pip-audit
        
      - name: Check for vulnerable dependencies
        run: |
          pip install -r requirements.txt
          pip-audit --desc
        continue-on-error: true
