/*
    Sentinel YARA Rules - Malware Detection
    These rules detect common malware patterns, suspicious behaviors, and IOCs.
    100% Offline - No network required.
*/

rule Suspicious_PowerShell_Encoded {
    meta:
        description = "Detects PowerShell encoded command execution"
        severity = "high"
        category = "execution"
    strings:
        $enc1 = "-EncodedCommand" ascii nocase
        $enc2 = "-enc " ascii nocase
        $enc3 = "-e " ascii nocase
        $enc4 = "FromBase64String" ascii nocase
        $enc5 = "[Convert]::FromBase64" ascii nocase
        $ps1 = "powershell" ascii nocase
        $ps2 = "pwsh" ascii nocase
    condition:
        any of ($ps*) and any of ($enc*)
}

rule Suspicious_PowerShell_Download {
    meta:
        description = "Detects PowerShell download cradles"
        severity = "high"
        category = "download"
    strings:
        $dl1 = "Invoke-WebRequest" ascii nocase
        $dl2 = "wget " ascii nocase
        $dl3 = "curl " ascii nocase
        $dl4 = "Net.WebClient" ascii nocase
        $dl5 = "DownloadString" ascii nocase
        $dl6 = "DownloadFile" ascii nocase
        $dl7 = "Invoke-Expression" ascii nocase
        $dl8 = "IEX" ascii nocase
        $dl9 = "Start-BitsTransfer" ascii nocase
    condition:
        2 of them
}

rule Suspicious_Script_Obfuscation {
    meta:
        description = "Detects common script obfuscation techniques"
        severity = "medium"
        category = "obfuscation"
    strings:
        $ob1 = /\$[a-zA-Z]{1,3}\s*=\s*\[char\]\d+/ ascii
        $ob2 = "replace(" ascii nocase
        $ob3 = "-join" ascii nocase
        $ob4 = "[char]" ascii nocase
        $ob5 = "char(" ascii nocase
        $ob6 = "String.fromCharCode" ascii nocase
        $ob7 = "eval(" ascii nocase
        $ob8 = "unescape(" ascii nocase
    condition:
        3 of them
}

rule Suspicious_WMI_Execution {
    meta:
        description = "Detects WMI-based code execution"
        severity = "high"
        category = "execution"
    strings:
        $wmi1 = "wmic" ascii nocase
        $wmi2 = "Win32_Process" ascii nocase
        $wmi3 = "Win32_Service" ascii nocase
        $wmi4 = "Get-WmiObject" ascii nocase
        $wmi5 = "Invoke-WmiMethod" ascii nocase
        $create = "Create(" ascii nocase
        $process = "process" ascii nocase
    condition:
        any of ($wmi*) and ($create or $process)
}

rule Suspicious_Registry_Persistence {
    meta:
        description = "Detects registry-based persistence mechanisms"
        severity = "high"
        category = "persistence"
    strings:
        $reg1 = "CurrentVersion\\Run" ascii nocase
        $reg2 = "CurrentVersion\\RunOnce" ascii nocase
        $reg3 = "Policies\\Explorer\\Run" ascii nocase
        $reg4 = "reg add" ascii nocase
        $reg5 = "Set-ItemProperty" ascii nocase
        $reg6 = "New-ItemProperty" ascii nocase
        $reg7 = "RegSetValue" ascii nocase
    condition:
        any of them
}

rule Suspicious_Scheduled_Task {
    meta:
        description = "Detects scheduled task creation for persistence"
        severity = "high"
        category = "persistence"
    strings:
        $st1 = "schtasks" ascii nocase
        $st2 = "/create" ascii nocase
        $st3 = "Register-ScheduledTask" ascii nocase
        $st4 = "New-ScheduledTask" ascii nocase
        $st5 = "at.exe" ascii nocase
    condition:
        any of them
}

rule Suspicious_Credential_Access {
    meta:
        description = "Detects credential stealing indicators"
        severity = "critical"
        category = "credential_access"
    strings:
        $cred1 = "mimikatz" ascii nocase
        $cred2 = "sekurlsa" ascii nocase
        $cred3 = "lsass" ascii nocase
        $cred4 = "SAM" ascii
        $cred5 = "NTDS.dit" ascii nocase
        $cred6 = "credential" ascii nocase
        $cred7 = "password" ascii nocase
        $dump = "dump" ascii nocase
    condition:
        (any of ($cred*)) and $dump
}

rule Suspicious_Process_Injection {
    meta:
        description = "Detects process injection techniques"
        severity = "critical"
        category = "defense_evasion"
    strings:
        $api1 = "VirtualAllocEx" ascii
        $api2 = "WriteProcessMemory" ascii
        $api3 = "CreateRemoteThread" ascii
        $api4 = "NtCreateThreadEx" ascii
        $api5 = "RtlCreateUserThread" ascii
        $api6 = "QueueUserAPC" ascii
        $api7 = "SetThreadContext" ascii
    condition:
        2 of them
}

rule Suspicious_Shellcode_Indicators {
    meta:
        description = "Detects shellcode execution patterns"
        severity = "critical"
        category = "execution"
    strings:
        $sc1 = "VirtualAlloc" ascii
        $sc2 = "VirtualProtect" ascii
        $sc3 = "RtlMoveMemory" ascii
        $sc4 = "CallWindowProc" ascii
        $sc5 = { 90 90 90 90 }  // NOP sled
        $sc6 = { FC E8 }  // Common shellcode start
    condition:
        3 of them
}

rule Suspicious_Disable_Security {
    meta:
        description = "Detects attempts to disable security features"
        severity = "critical"
        category = "defense_evasion"
    strings:
        $dis1 = "Set-MpPreference" ascii nocase
        $dis2 = "DisableRealtimeMonitoring" ascii nocase
        $dis3 = "DisableBehaviorMonitoring" ascii nocase
        $dis4 = "DisableIOAVProtection" ascii nocase
        $dis5 = "netsh advfirewall set" ascii nocase
        $dis6 = "state off" ascii nocase
        $dis7 = "Windows Defender" ascii nocase
        $dis8 = "disable" ascii nocase
    condition:
        2 of them
}

rule Suspicious_Network_Commands {
    meta:
        description = "Detects suspicious network-related commands"
        severity = "medium"
        category = "command_and_control"
    strings:
        $net1 = "netcat" ascii nocase
        $net2 = "nc.exe" ascii nocase
        $net3 = "ncat" ascii nocase
        $net4 = "psexec" ascii nocase
        $net5 = "Test-NetConnection" ascii nocase
        $net6 = "New-Object System.Net.Sockets" ascii nocase
        $net7 = "TCPClient" ascii nocase
    condition:
        any of them
}

rule Suspicious_Data_Exfiltration {
    meta:
        description = "Detects potential data exfiltration indicators"
        severity = "high"
        category = "exfiltration"
    strings:
        $ex1 = "Compress-Archive" ascii nocase
        $ex2 = "Out-File" ascii nocase
        $ex3 = "Get-Content" ascii nocase
        $ex4 = "Upload" ascii nocase
        $ex5 = "ftp://" ascii nocase
        $ex6 = "sftp://" ascii nocase
        $ex7 = ".zip" ascii nocase
        $ex8 = ".rar" ascii nocase
    condition:
        3 of them
}

rule Suspicious_Batch_Commands {
    meta:
        description = "Detects suspicious batch file commands"
        severity = "medium"
        category = "execution"
    strings:
        $bat1 = "@echo off" ascii nocase
        $bat2 = "del /f /q" ascii nocase
        $bat3 = "rd /s /q" ascii nocase
        $bat4 = "net user" ascii nocase
        $bat5 = "net localgroup" ascii nocase
        $bat6 = "icacls" ascii nocase
        $bat7 = "takeown" ascii nocase
        $bat8 = "bcdedit" ascii nocase
    condition:
        3 of them
}

rule Suspicious_VBS_Script {
    meta:
        description = "Detects suspicious VBScript patterns"
        severity = "medium"
        category = "execution"
    strings:
        $vbs1 = "CreateObject" ascii nocase
        $vbs2 = "Wscript.Shell" ascii nocase
        $vbs3 = "Shell.Application" ascii nocase
        $vbs4 = "ADODB.Stream" ascii nocase
        $vbs5 = "Scripting.FileSystemObject" ascii nocase
        $vbs6 = ".Run" ascii nocase
        $vbs7 = ".Exec" ascii nocase
    condition:
        3 of them
}

rule Suspicious_JavaScript_Dropper {
    meta:
        description = "Detects JavaScript dropper patterns"
        severity = "high"
        category = "execution"
    strings:
        $js1 = "WScript.Shell" ascii nocase
        $js2 = "ActiveXObject" ascii nocase
        $js3 = "Scripting.FileSystemObject" ascii nocase
        $js4 = ".SaveToFile" ascii nocase
        $js5 = ".Write" ascii nocase
        $js6 = "ADODB.Stream" ascii nocase
        $js7 = "new ActiveXObject" ascii nocase
    condition:
        3 of them
}

rule Ransomware_Indicators {
    meta:
        description = "Detects ransomware-like behavior indicators"
        severity = "critical"
        category = "impact"
    strings:
        $ran1 = "encrypt" ascii nocase
        $ran2 = "decrypt" ascii nocase
        $ran3 = "ransom" ascii nocase
        $ran4 = "bitcoin" ascii nocase
        $ran5 = "wallet" ascii nocase
        $ran6 = ".locked" ascii nocase
        $ran7 = ".encrypted" ascii nocase
        $ran8 = "YOUR FILES" ascii nocase
        $ran9 = "pay" ascii nocase
    condition:
        3 of them
}

rule Suspicious_Base64_Blob {
    meta:
        description = "Detects large base64 encoded blobs"
        severity = "medium"
        category = "obfuscation"
    strings:
        $b64 = /[A-Za-z0-9+\/]{100,}={0,2}/ ascii
    condition:
        #b64 > 2
}

rule Suspicious_URL_Pattern {
    meta:
        description = "Detects embedded URLs in scripts"
        severity = "low"
        category = "indicator"
    strings:
        $url1 = /https?:\/\/[a-zA-Z0-9\-\.]+\.[a-zA-Z]{2,}/ ascii
        $url2 = /ftp:\/\/[a-zA-Z0-9\-\.]+/ ascii
    condition:
        any of them
}

rule Suspicious_IP_Address {
    meta:
        description = "Detects hardcoded IP addresses"
        severity = "low"
        category = "indicator"
    strings:
        $ip = /\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/ ascii
    condition:
        #ip > 0
}

rule PE_Suspicious_Imports {
    meta:
        description = "PE with suspicious import combination"
        severity = "high"
        category = "suspicious_pe"
    strings:
        $mz = { 4D 5A }
        $imp1 = "VirtualAlloc" ascii
        $imp2 = "VirtualProtect" ascii
        $imp3 = "CreateRemoteThread" ascii
        $imp4 = "WriteProcessMemory" ascii
        $imp5 = "LoadLibrary" ascii
        $imp6 = "GetProcAddress" ascii
    condition:
        $mz at 0 and 4 of ($imp*)
}

rule PE_Packed_Executable {
    meta:
        description = "Detects packed or encrypted executables"
        severity = "medium"
        category = "obfuscation"
    strings:
        $mz = { 4D 5A }
        $upx = "UPX" ascii
        $aspack = "ASPack" ascii
        $petite = "PEtite" ascii
        $mpress = "MPRESS" ascii
        $themida = "Themida" ascii
        $vmprotect = "VMProtect" ascii
    condition:
        $mz at 0 and any of ($upx, $aspack, $petite, $mpress, $themida, $vmprotect)
}
